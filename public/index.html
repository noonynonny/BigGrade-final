<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BigGrade</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    
    .permission-prompt {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #667eea;
      color: white;
      padding: 16px;
      text-align: center;
      z-index: 10000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
    }
    
    .permission-prompt.show {
      display: block;
    }
    
    .permission-prompt button {
      background: white;
      color: #667eea;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      margin: 0 8px;
      font-size: 14px;
    }
    
    .permission-prompt button:hover {
      background: #f7fafc;
    }
    
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 9999;
    }
    
    .loading.hide {
      display: none;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading p {
      margin-top: 16px;
      color: #4a5568;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="permission-prompt" id="permission-prompt">
    <p style="margin-bottom: 12px;">
      <strong>BigGrade needs permission to remember your sign-in</strong><br>
      <small>This allows you to stay signed in across visits</small>
    </p>
    <button onclick="requestAccess()">Allow</button>
    <button onclick="hidePrompt()">Not Now</button>
  </div>
  
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Loading BigGrade...</p>
  </div>
  
  <iframe 
    id="app-iframe"
    src="https://biggrade0.base44.app"
    sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-storage-access-by-user-activation"
    allow="camera; microphone; clipboard-read; clipboard-write; fullscreen; payment; geolocation; storage-access"
    allowfullscreen
  ></iframe>

  <script>
    const iframe = document.getElementById('app-iframe');
    const loading = document.getElementById('loading');
    const prompt = document.getElementById('permission-prompt');
    
    let storageAccessGranted = false;
    
    // Hide loading after iframe loads
    iframe.addEventListener('load', () => {
      setTimeout(() => {
        loading.classList.add('hide');
        
        // Check if we need to request storage access
        checkStorageAccess();
      }, 1000);
    });
    
    async function checkStorageAccess() {
      try {
        // Check if Storage Access API is supported
        if (!document.hasStorageAccess) {
          console.log('Storage Access API not supported');
          return;
        }
        
        // Check if we already have access
        const hasAccess = await document.hasStorageAccess();
        
        if (hasAccess) {
          console.log('✅ Already have storage access');
          storageAccessGranted = true;
          notifyIframe();
        } else {
          console.log('❌ No storage access yet');
          // Show prompt to user
          setTimeout(() => {
            prompt.classList.add('show');
          }, 2000);
        }
      } catch (error) {
        console.error('Error checking storage access:', error);
      }
    }
    
    async function requestAccess() {
      try {
        // Request storage access
        await document.requestStorageAccess();
        
        console.log('✅ Storage access granted!');
        storageAccessGranted = true;
        hidePrompt();
        
        // Notify iframe and reload it
        notifyIframe();
        
        // Reload iframe to apply new permissions
        iframe.src = iframe.src;
        
      } catch (error) {
        console.error('❌ Storage access denied:', error);
        alert('Storage access was denied. Some features may not work properly.');
        hidePrompt();
      }
    }
    
    function hidePrompt() {
      prompt.classList.remove('show');
    }
    
    function notifyIframe() {
      // Try to notify the iframe that storage access is granted
      try {
        iframe.contentWindow.postMessage({
          type: 'storage-access-granted',
          granted: storageAccessGranted
        }, 'https://biggrade0.base44.app');
      } catch (error) {
        console.log('Could not notify iframe:', error);
      }
    }
    
    // Listen for messages from iframe
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://biggrade0.base44.app') return;
      
      if (event.data.type === 'request-storage-access') {
        if (!storageAccessGranted) {
          prompt.classList.add('show');
        }
      }
    });
    
    // Try to request storage access automatically on user interaction
    document.addEventListener('click', async () => {
      if (!storageAccessGranted && document.hasStorageAccess) {
        try {
          const hasAccess = await document.hasStorageAccess();
          if (!hasAccess) {
            // Show prompt
            prompt.classList.add('show');
          }
        } catch (e) {
          console.log('Auto-check failed:', e);
        }
      }
    }, { once: true });
  </script>
</body>
</html>
